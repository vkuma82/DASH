FROM sc-client

ENV SAI_CHALLENGER_PATH /sai-challenger
ENV DASH_PATH /dash

ADD tests/ /tests/

# Copy distro PTF submodule and tools from SAI repo
ADD SAI/SAI/test/ptf /SAI/test/ptf

# Install PTF test framework & test-cases from SAI repo
ADD SAI/SAI/ptf /SAI/ptf/

# Copy thrift python distro
ADD SAI/rpc/thrift-0.11.0.tar.gz /

# Copy autogenerated saithrift library built from SAI headers for DASH dataplane
ADD SAI/rpc/saithrift-0.9.tar.gz /

# Install the python libraries
RUN python3 -m pip install -r /tests/requirements.txt && \
    pip3 install scapy \
                 dpugen>=0.0.3 \
                 pysubnettree \
                 macaddress \
                 munch && \
    cd /saithrift-0.9 && \
        python3 setup.py install && \
    cd / && \
        rm -rf saithrift-0.9 &&\
    cd thrift-0.11.0 && \
        python3 setup.py install && \
    cd / &&\
        rm -rf thrift-0.11.0 && \
    cd /SAI/test/ptf && \
        python3 setup.py install && \
    ln -s ${SAI_CHALLENGER_PATH} /usr/local/lib/python3.7/dist-packages/saichallenger && \
    ln -s ${DASH_PATH}/test/test-cases/scale/saic ${SAI_CHALLENGER_PATH}/dash_tests && \
    ln -s ${DASH_PATH}/dash-pipeline/cgyang/saigen /usr/local/lib/python3.7/dist-packages/saigen

CMD ["/usr/bin/supervisord"]
